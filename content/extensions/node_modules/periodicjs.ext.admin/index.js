'use strict';

var path = require('path'),
		multer  = require('multer');
module.exports = function(periodic){
	// express,app,logger,config,db,mongoose
	var adminRouter = periodic.express.Router(),
		itemRouter = periodic.express.Router(),
		tagRouter = periodic.express.Router(),
		tagAdminRouter = periodic.express.Router(),
		mediaRouter = periodic.express.Router(),
		userRouter = periodic.express.Router(),
		contenttypeRouter = periodic.express.Router(),
		contenttypeAdminRouter = periodic.express.Router(),
		categoryRouter = periodic.express.Router(),
		categoryAdminRouter = periodic.express.Router(),
		collectionRouter = periodic.express.Router(),
		extensionRouter = periodic.express.Router(),
		themeRouter = periodic.express.Router(),
		periodicRouter = periodic.express.Router(),
		themeController = require('../../../../app/controller/theme')(periodic),
		extController = require('../../../../app/controller/extension')(periodic),
		itemController = require('../../../../app/controller/item')(periodic),
		tagController = require('../../../../app/controller/tag')(periodic),
		mediaassetController = require('../../../../app/controller/asset')(periodic),
		categoryController = require('../../../../app/controller/category')(periodic),
		userController = require('../../../../app/controller/user')(periodic),
		contenttypeController = require('../../../../app/controller/contenttype')(periodic),
		collectionController = require('../../../../app/controller/collection')(periodic),
		adminController = require('./controller/admin')(periodic),
		authController = require('../periodicjs.ext.login/controller/auth')(periodic),
		uacController = require('../periodicjs.ext.user_access_control/controller/uac')(periodic);

	/**
	 * admin routes
	 */
	// adminRouter.get('/',authController.ensureAuthenticated,adminController.index);
	adminRouter.all('*',adminController.loadUserRoles);
	adminRouter.get('/',function(req,res,next){
		res.redirect('/p-admin/items');
	});
	adminRouter.get('/extensions',authController.ensureAuthenticated,adminController.loadExtensions,adminController.extensions_index);
	adminRouter.get('/themes',authController.ensureAuthenticated,adminController.loadThemes,adminController.themes_index);
	adminRouter.get('/items',authController.ensureAuthenticated,itemController.loadItems,adminController.items_index);
	adminRouter.get('/contenttypes',authController.ensureAuthenticated,contenttypeController.loadContenttypes,adminController.contenttypes_index);
	adminRouter.get('/tags',authController.ensureAuthenticated,tagController.loadTags,adminController.tags_index);
	adminRouter.get('/categories',authController.ensureAuthenticated,categoryController.loadCategories,adminController.categories_index);
	adminRouter.get('/collections',authController.ensureAuthenticated,collectionController.loadCollections,adminController.collections_index);
	adminRouter.get('/assets',authController.ensureAuthenticated,mediaassetController.loadAssets,adminController.assets_index);
	adminRouter.get('/users',authController.ensureAuthenticated,uacController.loadUacUsers,adminController.users_index);
	adminRouter.get('/mailer',authController.ensureAuthenticated,adminController.mail_index);
	/**
	 * admin/extension manager routes
	 */
	extensionRouter.get('/install',authController.ensureAuthenticated,extController.install);
	extensionRouter.get('/install/log/:extension/:date',authController.ensureAuthenticated,extController.install_getOutputLog);
	extensionRouter.get('/upload/log/:extension/:date',authController.ensureAuthenticated,extController.upload_getOutputLog);
	extensionRouter.get('/remove/log/:extension/:date',authController.ensureAuthenticated,extController.remove_getOutputLog);
	extensionRouter.get('/cleanup/log/:extension/:date',authController.ensureAuthenticated,extController.cleanup_log);
	extensionRouter.get('/:id/disable',authController.ensureAuthenticated,adminController.loadExtensions,adminController.loadExtension,extController.disable);
	extensionRouter.get('/:id/enable',authController.ensureAuthenticated,adminController.loadExtensions,adminController.loadExtension,extController.enable);
	extensionRouter.post('/upload',authController.ensureAuthenticated,mediaassetController.upload,extController.upload_install);
	extensionRouter.post('/:id/delete',authController.ensureAuthenticated,adminController.loadExtension,extController.remove);
	extensionRouter.get('/:id',authController.ensureAuthenticated,adminController.loadExtension,adminController.extension_show);
	/**
	 * admin/theme manager routes
	 */
	themeRouter.get('/install',authController.ensureAuthenticated,themeController.install);
	themeRouter.get('/install/log/:theme/:date',authController.ensureAuthenticated,themeController.install_getOutputLog);
	themeRouter.get('/upload/log/:theme/:date',authController.ensureAuthenticated,themeController.upload_getOutputLog);
	themeRouter.get('/remove/log/:theme/:date',authController.ensureAuthenticated,themeController.remove_getOutputLog);
	themeRouter.get('/cleanup/log/:theme/:date',authController.ensureAuthenticated,themeController.cleanup_log);
	themeRouter.get('/:id/enable',authController.ensureAuthenticated,themeController.enable);
	themeRouter.post('/upload',authController.ensureAuthenticated,mediaassetController.upload,themeController.upload_install);
	themeRouter.post('/:id/delete',authController.ensureAuthenticated,themeController.remove);
	themeRouter.get('/:id',authController.ensureAuthenticated,adminController.loadTheme,adminController.theme_show);
	/**
	 * admin/post manager routes
	 */
	adminRouter.get('/item/new',authController.ensureAuthenticated,adminController.item_new);
	adminRouter.get('/item/edit/:id',authController.ensureAuthenticated,itemController.loadFullItem,adminController.item_edit);
	itemRouter.post('/new',authController.ensureAuthenticated,itemController.create);
	// itemRouter.post('/new',itemController.loadItem,authController.ensureAuthenticated,itemController.create);
	itemRouter.post('/edit',authController.ensureAuthenticated,itemController.update);
	/**
	 * admin/collection manager routes
	 */
	adminRouter.get('/collection/new',authController.ensureAuthenticated,adminController.collection_new);
	adminRouter.get('/collection/edit/:id',authController.ensureAuthenticated,collectionController.loadCollection,adminController.collection_edit);
	collectionRouter.post('/new',authController.ensureAuthenticated,collectionController.create);
	// collectionRouter.post('/new',collectionController.loadCollection,authController.ensureAuthenticated,collectionController.create);
	collectionRouter.post('/edit',authController.ensureAuthenticated,collectionController.update);
	collectionRouter.post('/append/:id',authController.ensureAuthenticated,collectionController.loadCollection,collectionController.append);

	// collectionRouter.post('/:id/delete',authController.ensureAuthenticated,collectionController.remove);
	/**
	 * admin/tag manager routes
	 */
	tagRouter.post('/new/:id',multer({ dest: process.cwd() + '/public/uploads/files'}),tagController.loadTag,tagController.create);
	tagRouter.post('/new',multer({ dest: process.cwd() + '/public/uploads/files'}),tagController.loadTag,tagController.create);
	tagAdminRouter.get('/:id',authController.ensureAuthenticated,tagController.loadTag,adminController.tag_show);
	/**
	 * admin/category manager routes
	 */
	categoryRouter.post('/new/:id',multer({ dest: process.cwd() + '/public/uploads/files'}),categoryController.loadCategory,categoryController.create);
	categoryRouter.post('/new',multer({ dest: process.cwd() + '/public/uploads/files'}),categoryController.loadCategory,categoryController.create);
	categoryAdminRouter.get('/:id',authController.ensureAuthenticated,categoryController.loadCategory,adminController.category_show);
	/**
	 * admin/categorytype manager routes
	 */
	contenttypeRouter.post('/new/:id',multer({ dest: process.cwd() + '/public/uploads/files'}),contenttypeController.loadContenttype,contenttypeController.create);
	contenttypeRouter.post('/new',multer({ dest: process.cwd() + '/public/uploads/files'}),contenttypeController.loadContenttype,contenttypeController.create);
	contenttypeRouter.post('/append/:id',authController.ensureAuthenticated,contenttypeController.loadContenttype,contenttypeController.append);
	contenttypeRouter.post('/removeitem/:id',authController.ensureAuthenticated,contenttypeController.loadContenttype,contenttypeController.removeitem);
	contenttypeAdminRouter.get('/:id',authController.ensureAuthenticated,contenttypeController.loadContenttype,adminController.contenttype_show);
	/**
	 * admin/media manager routes
	 */
	mediaRouter.post('/new',authController.ensureAuthenticated,mediaassetController.upload,mediaassetController.createassetfile);
	mediaRouter.post('/:id/delete',authController.ensureAuthenticated,mediaassetController.loadAsset,mediaassetController.remove);
	/**
	 * admin/user routes
	 */
	userRouter.get('/edit-access',authController.ensureAuthenticated,uacController.loadUserAccesControls,adminController.users_access);
	userRouter.get('/:id',authController.ensureAuthenticated,userController.loadUser,adminController.users_show);
	// userRouter.post('/new',authController.ensureAuthenticated,mediaassetController.upload,mediaassetController.createassetfile);

	/**
	 * periodic routes
	 */
	periodicRouter.get('/user/search.:ext',userController.loadUsers,userController.searchResults);
	periodicRouter.get('/user/search',userController.loadUsers,userController.searchResults);
	periodicRouter.get('/category/search.:ext',categoryController.loadCategories,categoryController.searchResults);
	periodicRouter.get('/category/search',categoryController.loadCategories,categoryController.searchResults);
	periodicRouter.get('/contenttype/search.:ext',contenttypeController.loadContenttypes,contenttypeController.searchResults);
	periodicRouter.get('/contenttype/search',contenttypeController.loadContenttypes,contenttypeController.searchResults);
	periodicRouter.get('/tag/search.:ext',tagController.loadTags,tagController.searchResults);
	periodicRouter.get('/tag/search',tagController.loadTags,tagController.searchResults);


	adminRouter.use('/extension',extensionRouter);
	adminRouter.use('/theme',themeRouter);
	adminRouter.use('/contenttype',contenttypeAdminRouter);
	adminRouter.use('/tag',tagAdminRouter);
	adminRouter.use('/category',categoryAdminRouter);
	adminRouter.use('/user',userRouter);
	periodic.app.use('/p-admin',adminRouter);
	periodic.app.use('/item',itemRouter);
	periodic.app.use('/collection',collectionRouter);
	periodic.app.use('/tag',tagRouter);
	periodic.app.use('/category',categoryRouter);
	periodic.app.use('/contenttype',contenttypeRouter);
	periodic.app.use('/mediaasset',mediaRouter);
	periodic.app.use(periodicRouter);
};